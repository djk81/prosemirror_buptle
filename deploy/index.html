<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUPTLE - Prosemirror</title>
    <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/reset.css">
    <!-- <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/jquery-ui.structure.min.css">
    <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/jquery-ui.theme.min.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/application.css"> -->
    <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/css/style.css">
    <link rel="stylesheet" type="text/css" href="http://test1.buptlestg.com/static/adele/scripts/buptle_editor.css">

    <!-- SCRIPT -->
    <script src="http://test1.buptlestg.com/static/tenant/js/jquery-3.3.1.min.js"></script>
    <script src="http://test1.buptlestg.com/static/adele/scripts/jquery-ui.min.js"></script>
    
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/polyfills.umd.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.auto.js"></script>
    <!-- <script type="text/javascript" src="../src/jspdf.min.js"></script> -->
    
    <style>
        .box {
            padding: 2em;
        }
        .btn {
            border: 1px solid gray;
            border-radius: 10px;
            padding: .5em 1em;
        }
    </style>
</head>

<body>
    <header class="box" style="color: #fff; background: #000;">
        <h2>BUPTLE - Prosemirror</h2>
    </header>
    <!-- START test 용 -->
    <section class="btn">
        <h2>커스텀 기능</h2>
        <article>
            <form id="commit">
                저장 커밋메시지
                <input type="text" id="message" name="message">
                <button class="btn" id="commitbutton" type="button" onclick="">버전저장</button>
                <div class="blame-wrap">
                    <button type="button" id="blame" style="display:none;">blame at cursor</button>
                </div>
            </form>
        </article>
    </section>
    <!-- END test 용 -->

    <section class="box" style="display: flex;">
        <div>
            <!-- START proseMirror -->
            <section class="contract_view">
                <div id="div-contract-content" class="contract_area pdfArea"></div>
            
                <div id="content" style="display: none;">
                    <p>
                        <span contenteditable="false" draggable="true" style="position: relative; width: 10em; display: inline-block; padding-left: 0.25em;">
                            <span style="position: absolute; bottom: 0px; right: 0px; width: 10px; height: 10px; border-top: none; border-right: 3px solid orange; border-bottom: 3px solid orange; border-left: none; border-image: initial; cursor: nwse-resize; display: none;"></span>
                            <img contenteditable="false" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRu2gszn8rjq-xLNIps0X24fMM186kforEe1Orw_G1bqXBc2P91" class="" style="width: 19.25em; vertical-align: bottom !important;">
                        </span>
                    </p>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Velit consequuntur pariatur voluptatem nobis, beatae aliquam enim quis aperiam ipsam tenetur, iure accusamus qui? Neque, quod ad veritatis nobis natus, alias laborum,</p>
                </div>
            </section>
            <!-- END proseMirror -->
        </div>
    </section>

    <!-- START src/index.js bundling -->
    <script src="../dist/buptle_editor.js"></script>
    <!-- END src/index.js bundling -->

    <!-- START test script -->
    <script>
        var _editorView = null;
        try {
            var activate_plugins = true
            var pm = ProseMirror;
            var _editorSpec = new pm.EditorSpec();
            // svg 아이콘 위치
            if (activate_plugins) {
                _editorSpec.icons_base_path = 'https://test1.buptlestg.com/static/adele/imgs/';
                _editorSpec.div_target_id = 'div-contract-content';
                _editorSpec.is_memo_activate = true;
                _editorSpec.is_track_changes_activate = true;
                _editorSpec.div_comments_target_id = 'indexhtml_comment_list_wrapper';
                _editorSpec.get_document_html_handler = function () {
                    return document.querySelector("#content")
                };
                _editorSpec.functions = {
                    getCheckboxEditable: function () {
                        alert('못만짐');
                        return false;
                    },
                    get_comments: function () {
                        var comments = {
                            comments: []
                        };

                        var memos = []

                        for (var indx in memos) {
                            comments.comments.push({
                                from: 3,
                                to: 4,
                                text: '메모',
                                id: '1',
                                extra: {
                                    user_name: '유저네임',
                                    user_id: '100'
                                }
                            });
                        }

                        return comments;
                    },
                    addAnnotation: function (commentPlugin, state, dispatch, _Comment, _randomId_fnc) {
                        // console.log(' >>>>>> ' + state);
                        // console.log(' >>>>>> ' + dispatch);
                        let sel = state.selection
                        if (sel.empty) {
                            return false
                        }
                        if (dispatch) {
                            let text = prompt("진짜진짜진짜", "");
                            if (text)
                                dispatch(state.tr.setMeta(commentPlugin, {
                                    type: "newComment",
                                    from: sel.from,
                                    to: sel.to,
                                    comment: new _Comment(text, _randomId_fnc(), {
                                        111: '2222'
                                    })
                                }))
                        }
                        return true

                    },
                    btpmRenderCommentHandler: function (comment, dispatch, state) {
                        return fn_handle_comment_in_editor(comment, dispatch, state);
                    }
                };

            } else {
                _editorSpec.div_target_id = 'editor';
                _editorSpec.get_document_html_handler = function () {
                    return document.querySelector("#content")
                };
            }
        } catch (e) {
            window.console.log(e);
        }

        _editorView = ProseMirror.editorInitBySpec(_editorSpec, function () {

        });

        ProseMirror.setPMContentFromHTML();

        window.addEventListener('DOMContentLoaded', function () {
            var _rs_fields = document.querySelectorAll('.buptleparam_content_required_none');
            for (var i = 0; i < _rs_fields.length; i++) {
                _rs_fields[i].addEventListener("click", function () {
                    alert(this.innerText);
                    this.innerText = '입력했음';
                }, false)

            }
        })

        function fn_handle_comment_in_editor(comment, dispatch, state) {
            console.log('render comment outer !! -> ' + comment.id);
            // let btn = crel("button", {class: "commentDelete", title: "delete하기"}, "삭제")
            let btn = $('<button></button>').addClass('commentDelete').attr('title', 'del하자').text('delete');

            try {
                var test_function = function (id) {
                    alert(id + "를 삭제합니다.");
                }

                btn.bind('click', function () {
                    dispatch(state.tr.setMeta(ProseMirror.commentPlugin, {
                        type: "deleteComment",
                        comment: comment,
                        ext_func: test_function
                    }))
                });
            } catch (e) {
                console.log(e);
            }

            // 선택된 코멘트 강조
            var rtn = $('<li></li>').addClass('commentText').text(comment.text).append(btn.get(0)).get(0);
            console.log(rtn);
            return rtn
        }

        // 메모관련
        function fn_draw_memo_handle(_comments, action) {
            var _memo_html_text = "<li class='_comments_panel' id='_comments_panel_id_{id}'>";
            _memo_html_text += '<div class="cont_memo_box">';
            _memo_html_text += '  <div class="cont_memo_hd clearfix">';
            _memo_html_text += '  <p class="sm_p">{user_name}</p>';
            _memo_html_text += '  <p class="sm_pb4">{time}</p>';
            _memo_html_text += '  </div>';
            _memo_html_text += '  <div class="cont_memo_text">';
            _memo_html_text += '    <p class="sm_p58"><pre>{comment}</pre>';
            _memo_html_text += '   </p>';
            _memo_html_text += '  </div>';

            _memo_html_text += '  <div class="cont_memo_btn clearfix"><div class="fl reply_btn_wrap">';
            _memo_html_text += '  <p class="btn_replay_s">수정</p><p class="btn_replay_s">삭제</p></div>';
            _memo_html_text +=
                '  <div class="fr reply_btn_wrap"><p class="btn_replay_s">회신</p><p class="btn_replay_s resolve">해결</p></div>';
            _memo_html_text += '  </div>';
            _memo_html_text += '</li>';


            var _htmlText = '';
            for (indx in _comments) {

                var _oneComment = _comments[indx];
                var _ex = _oneComment.spec.comment.extra

                _htmlText += _memo_html_text.replace('{user_name}', _ex.user_name)
                    .replace('{id}', _oneComment.spec.comment.id)
                    .replace('{time}', _ex.time)
                    .replace('{comment}', _oneComment.spec.comment.text);
            }

            document.querySelector("#indexhtml_comment_list_wrapper").innerHTML = _htmlText;
            // $("#").html(_htmlText);

            let _comments_panels = document.querySelectorAll("._comments_panel");
            for (var i = 0; i < _comments_panels.length; i++) {
                let _tmp_id = _comments_panels[i].id.split('_comments_panel_id_')[1];
                try {
                    _comments_panels[i].addEventListener("click", function () {
                        // alert('tmp_id' + _tmp_id);
                        ProseMirror.btpmOnCommentBtClicked(_tmp_id);
                    }, false)
                } catch (e) {
                    console.log(e);
                }
            }
        }

        // $('.ProseMirror').attr('contenteditable', false);
    </script>
    <!-- END test script -->
</body>
</html>